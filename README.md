# portman

`portman` transforms your local project URLs from http://localhost:8080 and http://localhost:3000 to pretty URLs like https://foo.localhost and https://bar.localhost.

`portman` has three components:

1. The CLI lets you register projects and generates unique port assignments for each one.
1. The shell integration automatically sets the PORT environment variable when you `cd` into the project's directory.
1. The [caddy](https://caddyserver.com) integration automatically generates a Caddyfile that caddy will use to reverse-proxy your localhost:\* urls to https://\*.localhost URLs.

## Installation

```sh
# Install portman CLI
brew install canac/tap/portman

# Install fish shell integration
echo "portman init fish | source" >> ~/.config/fish/config.fish

# Install and start caddy
brew install caddy
brew services start caddy
```

## Basic usage

```sh
# Allocate a new autogenerated port for this project
cd my-cool-project
portman allocate

# Check that the shell integration automatically set the $PORT
echo $PORT

# Run the project's dev server how you normally would
npm run dev
```

## Gallery

portman provides a simple web server for graphically viewing all of your allocated projects and some basic information about them. It is available at https://localhost.

## Matchers

When the current directory changes, portman searches through the list of allocated projects to see if any of them match the current directory. If any match, it activates the project by setting `$PORT` to that project's port. By default, portman searches by the current working directory when the project was allocated. However, if the project moves directories or if you `cd` into a subdirectory of the project, portman won't be able to tell that you entered that project because the directories won't match. To alleviate this, multiple matching strategies are available.

### `--matcher=dir`

This is the default matching strategy. portman remembers the current working directory when a project is allocated and activates a project whenever the current working directory matches the projects' saved working directory.

### `--matcher=git`

This matching strategy takes advantage of the stability of a project's git origin URL to still be able to find projects when they move around on the filesystem or when entering a project's subdirectory. portman runs `git --get remote.origin.url` to retrieve the origin URL when a project is allocated and activates a project whenever the output of `git --get remote.origin.url` matches the project's saved origin URL. One caveat with this matcher is that if you have multiple clones of the same repository, portman won't be able to distinguish them and will allocate the same port to them, which may or may not be desirable.

```sh
# Setup the project and allocate a port
git clone https://github.com/user/project.git
cd project
portman allocate --matcher=git

# Rename the project
cd ..
mv project project-renamed

# portman can still find the project
cd .
```

### `--matcher=none`

This matching strategy turns off matching. The project will never be activated automatically. You can still get the project's port by passing the project's name to `portman get`.

```sh
# Run the project's dev server how you normally would, passing it the generated PORT
cd my-cool-project
PORT=$(portman get my-cool-project) npm run dev
```

## Project names

portman can usually infer a name for a project. Therefore, the name argument can often be omitted from `allocate`, `get`, and `release`. The default project name depends on the matching strategy.

When the matching strategy is [`dir`](#--matcherdir) (the default), the project name defaults to the name of the current directory.

```sh
cd /path/to/my-project
# Project name defaults to "my-project"
portman allocate
```

When the matching strategy is [`git`](#--matchergit), the project name defaults to the name of the GitHub project. Currently, only GitHub repositories are supported when extracting the project name from the remote origin URL.

```sh
git clone https://github.com/user/my-project.git
cd my-project
# Project name defaults to "my-project"
portman allocate
```

When the matching strategy is [`none`](#--matchernone), the project name has no default and must be provided manually.

## Manual port assignment

Sometimes, a randomly-assigned port doesn't work because a server hard-codes the port to listen on, for example. In that case, simply provide the `--port` flag.

```sh
portman allocate --port=1234
```

This port can even fall outside of the configured range of allowable ports.

## Redirecting instead of reverse-proxying

Sometimes, using a reverse-proxied domain like https://my-project.localhost doesn't work because of CORS or other architectural factors. In that case, simply provide the `--redirect` flag. Now, navigating to `https://my-project.localhost` will redirect to http://localhost:$PORT instead of reverse-proxying.

```sh
portman allocate --port=9000 --redirect
```

## CLI API

### `portman -h`, `portman --help`

Prints CLI usage information.

### `portman -V`, `portman --version`

Prints portman version.

### `portman init fish`

Prints the shell configuration command to enable the shell integration. Currently, only Fish shell is supported, but other shells would be trivial to add.

### `portman allocate [project] [--port=PORT] [--matcher=dir|git|none] [--redirect]`

Allocates a new automatically generated port for a new project. If `project-name` is not provided, a default is calculated by the provided matcher. `project` is required if `--matcher=none`. If `port` is provided, that port will be used instead of randomly assigning one. See [matchers](#matchers) for more details about matchers configuration or [project names](#project-names) for more details about default project names. If `redirect` is specified, redirect to the server instead of reverse-proxying. See [here](#redirecting-instead-of-reverse-proxying) for more details.

`portman allocate` is idempotent, i.e. calling it multiple times with the same arguments will allocate a project the first time and do nothing for future invocations. However, an error will occur if a port, matcher, or redirect is provided that differs from the existing project's configuration.

### `portman get [project]`

Prints the port allocated for a project. If `project-name` is provided, it searches for a project by its name. If `project-name` is not provided, it searches for a project that matches the current directory according to the rules explained in [matchers](#matchers).

### `portman release [project]`

Releases the port allocated for a project. Just like `portman get`, if `project-name` is provided, it searches for a project by its name and releases the project found. If `project-name` is not provided, it searches for a project that matches the current directory according to the rules explained in [matchers](#matchers) and releases the project found.

### `portman list`

Lists all the ports assigned to all projects in alphabetical order.

### `portman reset`

Releases all ports allocated for all projects.

### `portman caddyfile`

Prints a valid Caddyfile that reverse-proxies all registered projects from their allocated ports to https://\*.localhost URLs.

### `portman reload-caddy`

Regenerates the Caddyfile and reloads the caddy config. portman updates the Caddyfile and reloads caddy whenever it makes changes, so this command should only be necessary if something else outside of portman's control is manipulating the Caddyfile or caddy config.

### `portman config show`

Prints the configuration that is currently being used.

### `portman config edit`

Opens the configuration file using the command in the `$EDITOR` environment variable.

## Configuring portman

portman has a few configuration parameters that can be tweaked. Run `portman config show` to locate the default config file location. Run `portman config edit` to open the configuration file with `$EDITOR`. You might want to copy the contents of the [`default_config.toml`](default_config.toml) file as a starting point and then make your desired changes. The config file location can also be changed by setting the `PORTMAN_CONFIG` environment variable.

```sh
PORTMAN_CONFIG=~/portman.toml portman config show
```

The config file is in TOML format. This is the default config:

```toml
ranges = [[3000, 3999]]
reserved = []
```

### `ranges`

`ranges` is an array of two-element `[start, end]` arrays representing the allowed port ranges. The first element is the beginning of the port range, inclusive, and the second element is the end of the port range, inclusive. For example, [[3000, 3999], [8000, 8099]] would allocate ports from 3000-3999 and 8000-8099.

Defaults to `[[3000, 3999]]` if omitted.

### `reserved`

`reserved` is an array of ports that are reserved and will not be allocated to any project. For example, if you want to allocate ports between 3000 and 3999, but port 3277 is used by a something on your machine, set `reserved` to `[3277]` to prevent portman from allocating port 3277 to a project.

Defaults to `[]` if omitted.

## Setting up DNS

Chromium-based browsers automatically resolve the `localhost` tld to 127.0.0.1. To use other browsers or other tools, you may need to configure your DNS to resolve \*.localhost to 127.0.0.1. I use [NextDNS](https://nextdns.io) for ad blocking, and it's trivial to add a rewrite in NextDNS for \*.localhost domains.

## Bonus: Starship integration

To show the port allocated to the current project in your [Starship](https://starship.rs) prompt, add this to your `starship.toml`:

```toml
[custom.port]
command = 'echo $PORT'
when = 'test -n "${PORT-}"'
format = ':[$output]($style) '
shell = ['bash', '--noprofile', '--norc']
```
