# portman

`portman` transforms your local project URLs from http://localhost:8080 and http://localhost:3000 to pretty URLs like https://foo.localhost and https://bar.localhost.

`portman` has three components:

1. The CLI lets you register projects and generates unique port assignments for each one.
1. The shell integration automatically sets the PORT environment variable when you `cd` into the project's directory.
1. The [caddy](https://caddyserver.com) integration automatically generates a Caddyfile that caddy will use to reverse-proxy your localhost:\* urls to https://\*.localhost URLs.

## Installation

```sh
# Install portman CLI
brew tap canac/homebrew-tap
brew install portman

# Install fish shell integration
echo "portman init fish | source" >> ~/.config/fish/config.fish

# Install and start caddy
brew install caddy
brew services start caddy
```

## Basic usage

```sh
# Allocate a new autogenerated port for this project
cd my-cool-project
portman allocate

# Manually change the current directory so that the shell integration will set the $PORT
cd .
echo $PORT

# Run the project's dev server how you normally would
npm run dev
```

## Advanced usage

portman can still be used without the shell integration.

```sh
# Run the project's dev server how you normally would, passing it the generated PORT
cd my-cool-project
PORT=$(portman get my-cool-project --allocate) npm run dev
```

Now you can see your project running at http://localhost:$PORT and reverse-proxied to https://my-cool-project.localhost

## CLI API

### `portman -h`, `portman --help`

Prints CLI usage information.

### `portman -V`, `portman --version`

Prints portman version.

### `portman init fish`

Prints the shell configuration command to enable the shell integration. Currently, only Fish shell is supported, but other shells would be trivial to add.

### `portman allocate [project]`

Allocates a new automatically generated port for a new project. Fails if a project with that name already exists. If `project-name` is not provided, the name of the project is extracted from the current git repo's GitHub URL. For example, if the git URL is `https://github.com/canac/portman.git`, the project name will be `portman`.

### `portman get [project]`

Prints the port allocated for a project. If `project-name` is not provided, the name of the project is extracted from the current git repo's GitHub URL. If the `--allocate` flag is provided, a port is allocated if the project doesn't have a port allocated instead of erroring.

### `portman release [project]`

Releases the port allocated for a project. If `project-name` is not provided, the name of the project is extracted from the current git repo's GitHub URL.

### `portman reset`

Releases all ports allocated for all projects.

### `portman caddyfile`

Prints a valid Caddyfile that reverse-proxies all registered projects from their allocated ports to https://\*.localhost URLs.

### `portman reload-caddy`

Regenerates the Caddyfile and reloads the caddy config. portman updates the Caddyfile and reloads caddy whenever it makes changes, so this command should only be necessary if something else outside of portman's control is manipulating the Caddyfile or caddy config.

### `portman config show`

Prints the configuration that is currently being used.

### `portman config edit`

Opens the configuration file using the command in the `$EDITOR` environment variable.

## Configuring portman

portman has a few configuration parameters that can be tweaked. Run `portman config show` to locate the default config file location. Run `portman config edit` to open the configuration file with `$EDITOR`. You might want to copy the contents of the [`default_config.toml`](default_config.toml) file as a starting point and then make your desired changes. The config file location can also be changed by setting the `PORTMAN_CONFIG` environment variable.

```sh
PORTMAN_CONFIG=~/portman.toml portman config show
```

The config file is in TOML format. This is the default config:

```toml
ranges = [[3000, 3999]]
reserved = []
```

### `ranges`

`ranges` is an array of two-element `[start, end]` arrays representing the allowed port ranges. The first element is the beginning of the port range, inclusive, and the second element is the end of the port range, inclusive. For example, [[3000, 3999], [8000, 8099]] would allocate ports from 3000-3999 and 8000-8099.

Defaults to `[[3000, 3999]]` if omitted.

### `reserved`

`reserved` is an array of ports that are reserved and will not be allocated to any project. For example, if you want to allocate ports between 3000 and 3999, but port 3277 is used by a something on your machine, set `reserved` to `[3277]` to prevent portman from allocating port 3277 to a project.

Defaults to `[]` if omitted.

## Setting up DNS

Chromium-based browsers automatically resolve the `localhost` tld to 127.0.0.1. To use other browsers or other tools, you may need to configure your DNS to resolve \*.localhost to 127.0.0.1. I use [NextDNS](https://nextdns.io) for ad blocking, and it's trivial to add a rewrite in NextDNS for \*.localhost domains.

## Bonus: Starship integration

To show the port allocated to the current project in your [Starship](https://starship.rs) prompt, add this to your `starship.toml`:

```toml
[custom.port]
command = 'echo $PORT'
when = 'test -n "${PORT-}"'
format = ':[$output]($style) '
shell = ['bash', '--noprofile', '--norc']
```
